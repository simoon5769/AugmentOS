# Single-stage build with Bun
FROM oven/bun:latest

WORKDIR /app

# Copy package files first (for better caching)
# Copy all package.json files from the monorepo
COPY package.json bun.lock ./
COPY packages/*/package.json ./packages/
COPY packages/apps/*/package.json ./packages/apps/

# Install dependencies
RUN bun install

# Copy source code
COPY . .

# Build packages in sequence
RUN echo "ğŸš€ Starting build process..." && \
    echo "âš™ï¸ Building packages/sdk..." && \
    cd packages/sdk && bun run build && \
    echo "âœ… Building packages/sdk..." && \
    echo "âš™ï¸ Building packages/utils..." && \
    cd ../utils && bun run build && \
    echo "âœ… Building packages/utils..." && \
    echo "âš™ï¸ Building packages/agents..." && \
    cd ../agents && bun run build && \
    echo "âœ… Building packages/agents..." && \
    echo "âš™ï¸ Building packages/cloud..." && \
    cd ../cloud && bun run build && \
    echo "âœ… Building packages/cloud..." && \
    echo "âš™ï¸ Building packages/apps/dashboard-manager..." && \
    cd ../apps/dashboard-manager && bun run build && \
    echo "ğŸ‰ğŸ‰ğŸ‰ All packages built successfully! ğŸ‰ğŸ‰ğŸ‰"

# Use Bun to run the application
ENV NODE_ENV=production
CMD ["echo", "Ready to run services"]
